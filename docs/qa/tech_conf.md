# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã

## –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ
### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ Redis –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
`Redis` –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Redis | –û–ø–∏—Å–∞–Ω–∏–µ | –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è |
|---|---|---|
|–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è| - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram-–±–æ—Ç–µ —á–µ—Ä–µ–∑ FSM,<br> - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ê–Ω–∞–ª–∏–∑–∞ | - [–§–¢-01](https://github.com/trofimovelijah/red-flag-analysis/issues/21),<br> - [–§–¢-02](https://github.com/trofimovelijah/red-flag-analysis/issues/23),<br> - [–§–¢-06](https://github.com/trofimovelijah/red-flag-analysis/issues/27),<br> - [–§–¢-12](https://github.com/trofimovelijah/red-flag-analysis/issues/33),<br> - [–§–¢-13](https://github.com/trofimovelijah/red-flag-analysis/issues/34),<br> - [–§–¢-15](https://github.com/trofimovelijah/red-flag-analysis/issues/36),<br> - [–§–¢-18](https://github.com/trofimovelijah/red-flag-analysis/issues/39),<br> - [–§–¢-19](https://github.com/trofimovelijah/red-flag-analysis/issues/40),<br> - [–§–¢-20](https://github.com/trofimovelijah/red-flag-analysis/issues/41) |
|–°—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ| –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤ (x/3) —Å TTL –Ω–∞ —Å—É—Ç–∫–∏ | - [–§–¢-03](https://github.com/trofimovelijah/red-flag-analysis/issues/24),<br> - [–§–¢-20](https://github.com/trofimovelijah/red-flag-analysis/issues/41),<br> - [–§–¢-25](https://github.com/trofimovelijah/red-flag-analysis/issues/46) |
|–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö| –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤, —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ `n8n`-–Ω–æ–¥–∞–º–∏ | - [–§–¢-07](https://github.com/trofimovelijah/red-flag-analysis/issues/28),<br> - [–§–¢-08](https://github.com/trofimovelijah/red-flag-analysis/issues/29),<br> - [–§–¢-11](https://github.com/trofimovelijah/red-flag-analysis/issues/32),<br> - [–§–¢-14](https://github.com/trofimovelijah/red-flag-analysis/issues/35),<br> - [–§–¢-24](https://github.com/trofimovelijah/red-flag-analysis/issues/45) |

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö Redis

| DB | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |	–û–ø–∏—Å–∞–Ω–∏–µ |
|---|---|---|
| db0	| –°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FSM) | –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram-–±–æ—Ç–µ: —Ç–µ–∫—É—â–∏–π —à–∞–≥, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ —Ñ–∞–π–ª, –æ–∂–∏–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ |
| db1	| –°—á—ë—Ç—á–∏–∫–∏ –ª–∏–º–∏—Ç–æ–≤ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ (`x/3`) |
| db2	| –ö—ç—à –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö | –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞, —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏, –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è `n8n` |

----
### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π Redis
–ù–∏–∂–µ –æ–ø–∏—Å–∞–Ω—ã –≤—Å–µ –∫–ª—é—á–∏, –∏—Ö —Ñ–æ—Ä–º–∞—Ç, —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –∏ TTL. –ò–º–µ–Ω–∞ –∫–ª—é—á–µ–π –≤—ã–±—Ä–∞–Ω—ã —Ç–∞–∫, —á—Ç–æ–±—ã –±—ã–ª–æ –ª–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

| –ö–ª—é—á | –¢–∏–ø | TTL, —Å–µ–∫ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è |
|---|---|---|---|---|
| **db0** |||||
| `session:{telegram_id}:state` | STRING | 3600 | –¢–µ–∫—É—â–∏–π —à–∞–≥ FSM –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | —Å–º. –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ *–¢–∞–±–ª–∏—Ü–µ —Å—Ç–∞—Ç—É—Å–æ–≤ FSM* |
| `session:{telegram_id}:data` | HASH | 3600 | –î–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ | file_name, file_size, file_format, upload_time, session_id |
| `session:{telegram_id}:lock` | STRING (SET NX) | 120 | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | 1 |
| **db1** |||||
| `limit:{telegram_id}:daily` | STRING (INCR) | –î–æ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–∏—Ö —Å—É—Ç–æ–∫ (EXPIREAT –Ω–∞ 23:59:59 MSK) | –°—á—ë—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ —Å—É—Ç–∫–∏ | 0, 1, 2, 3 |
| `limit:{telegram_id}:tariff` | STRING | –ë–µ–∑ TTL (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∞—Ä–∏—Ñ–∞) | –¢–∏–ø —Ç–∞—Ä–∏—Ñ–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ | FREE, PRO, PRO_PLUS |
| **db2** |||||
| `upload:{session_id}:meta` | HASH | 600 | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ | s3_key, original_name, size_bytes, mime_type, has_text_layer |
| `analysis:{session_id}:status` | STRING | 300 | –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ (–¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞) | —Å–º. *–¢–∞–±–ª–∏—Ü—É —Å—Ç–∞—Ç—É—Å–æ–≤ –∞–Ω–∞–ª–∏–∑–∞* |
| `analysis:{session_id}:progress` | HASH | 300 | –ü—Ä–æ–≥—Ä–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö | percent: 45, stage: SEARCHING, elapsed_sec: 12 |
| `analysis:{session_id}:result` | STRING (JSON) | 1800 | –ö—ç—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏/–ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ | JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ |

### –°—Ç–∞—Ç—É—Å—ã FSM
–°—Ç–∞—Ç—É—Å—ã –æ–ø–∏—Å—ã–≤–∞—é—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–µ—Å—Å–∏–∏ –≤ –¢–≥-–±–æ—Ç–µ. –≠—Ç–∏ —Å—Ç–∞—Ç—É—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞ `session:{telegram_id}:state`. –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å—Ç–∞—Ç—É—Å–∞–º–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π. 

–ó–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞ `ANALYZING` –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å—Ç–∞—Ç—É—Å—ã –º–æ–≥—É—Ç —Å–ª–µ–¥–æ–≤–∞—Ç—å –∫ `IDLE`. –í —Ü–µ–ª—è—Ö —É–¥–æ—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º–µ —ç—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥—ã –Ω–µ –ø–æ–∫–∞–∑–∞–Ω—ã. 

[![–î–∏–∞–≥—Ä–∞–º–º–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–µ—Å—Å–∏–∏](../images/status_fsm.png)](../images/status_fsm.png)

–ü–µ—Ä–µ—á–µ–Ω—å —Å—Ç–∞—Ç—É—Å–æ–≤ `FSM` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ | –°–ª–µ–¥—É—é—â–∏–µ —Å—Ç–∞—Ç—É—Å—ã	| –î–µ–π—Å—Ç–≤–∏–µ |
|---|---|---|---|
| IDLE | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª –±–æ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª | ‚Üí FILE_UPLOADED, TEXT_ENTERED, LINK_ENTERED | –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ |
| FILE_UPLOADED	| –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ MinIO, –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é	| ‚Üí ANALYZING, IDLE (–ø—Ä–∏ –æ—à–∏–±–∫–µ) | –ó–∞–ø—É—Å–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞ |
| TEXT_ENTERED | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç–∞–≤–∏–ª —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ | ‚Üí ANALYZING, IDLE (–ø—Ä–∏ –æ—à–∏–±–∫–µ) |–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã (100‚Äì6000 —Å–∏–º–≤–æ–ª–æ–≤)‚Äã |
| LINK_ENTERED | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª —Å—Å—ã–ª–∫—É –Ω–∞ Google Docs | ‚Üí ANALYZING, IDLE (–ø—Ä–∏ –æ—à–∏–±–∫–µ) | –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—Å—ã–ª–∫–∏‚Äã |
| ANALYZING	| –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (–ø–∞—Ä—Å–∏–Ω–≥ ‚Üí —á–∞–Ω–∫–∏–Ω–≥ ‚Üí –ø–æ–∏—Å–∫ ‚Üí LLM) | ‚Üí RESULT_READY, FAILED | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –∫–∞–∂–¥—ã–µ 2‚Äì3 —Å–µ–∫ |
| RESULT_READY | –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ—Ç–æ–≤ –∏ –æ—Ç–æ–±—Ä–∞–∂—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é | ‚Üí AWAITING_FEEDBACK, IDLE |–ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ ¬´–í—ã–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç¬ª –∏ ¬´–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å¬ª |
| AWAITING_FEEDBACK	| –û–∂–∏–¥–∞–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (üëç/üëé) | ‚Üí IDLE | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–¥–±—ç–∫–∞ –≤ PostgreSQL |
| FAILED | –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ | ‚Üí IDLE | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏, –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è |

### –°—Ç–∞—Ç—É—Å—ã –∞–Ω–∞–ª–∏–∑–∞ (–¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞)

–°—Ç–∞—Ç—É—Å—ã –≤ –∫–ª—é—á–µ `analysis:{session_id}:status` –æ—Ç—Ä–∞–∂–∞—é—Ç —Å—Ç–∞–¥–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

| –°—Ç–∞—Ç—É—Å | –ü—Ä–æ–≥—Ä–µ—Å—Å, % | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|---|---|
| QUEUED | 0 |–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç, –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| PARSING | 10 | –ü–∞—Ä—Å–∏–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–∞, —É–¥–∞–ª–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –≤—ë—Ä—Å—Ç–∫–∏ |
| CHUNKING | 25 | –†–∞–∑–±–∏–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞–Ω–∫–∏ |
| SEARCHING | 50 | –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫: Qdrant (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π) + PostgreSQL (BM25) |
| LLM_VERIFYING | 75 | LLM-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤, –æ—Ç—Å–µ–≤ false positives |
| GENERATING_REPORT | 90 | –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ |
| COMPLETED | 100 | –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ—Ç–æ–≤ |
| FAILED | | –û—à–∏–±–∫–∞ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ |


## –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

`MinIO` –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `S3`-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ö–ª—é—á–µ–≤–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ - —Ç—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö [–§–¢-24](https://github.com/trofimovelijah/red-flag-analysis/issues/45) / [–ë–µ–∑-1](https://github.com/trofimovelijah/red-flag-analysis/issues/61): –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∏ —É–¥–∞–ª—è—Ç—å—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞. –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ `MinIO`:

- –±—É—Ñ–µ—Ä –º–µ–∂–¥—É –∑–∞–≥—Ä—É–∑–∫–æ–π –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π - —Ç–≥-–±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–∞–π–ª, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ S3, –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º –ø–∞–π–ø–ª–∞–π–Ω (n8n-–ø–∞–π–ø–ª–∞–π–Ω) –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –µ–≥–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ,
- –∏–∑–æ–ª—è—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ø–æ —Å–µ—Å—Å–∏—è–º - –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –ø—Ä–∏–≤—è–∑–∞–Ω –∫ `session_id`, —á—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏,
- –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å [–§–¢-24](https://github.com/trofimovelijah/red-flag-analysis/issues/45) –ø–æ TTL,
- –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å S3 API - n8n –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –Ω–æ–¥—É.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∫–µ—Ç–æ–≤

| –ë–∞–∫–µ—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | Lifecycle (TTL) | –î–æ—Å—Ç—É–ø |
|---|---|---|---|
| `user-uploads` | –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ñ–∞–π–ª—ã (*.pdf, *.txt, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è) | 24 —á–∞—Å–∞ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ | –ó–∞–ø–∏—Å—å: —Ç–≥-–±–æ—Ç; –ß—Ç–µ–Ω–∏–µ: n8n –ø–∞—Ä—Å–µ—Ä |
| `analysis-reports` | –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ `PDF`/`TXT` –æ—Ç—á—ë—Ç—ã –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º | 7 –¥–Ω–µ–π ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ | –ó–∞–ø–∏—Å—å: n8n –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–æ–≤; –ß—Ç–µ–Ω–∏–µ: —Ç–≥-–±–æ—Ç |

### –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤

–û–±—ä–µ–∫—Ç—ã –≤–Ω—É—Ç—Ä–∏ –±–∞–∫–µ—Ç–æ–≤ –∏–º–µ–Ω—É—é—Ç—Å—è –ø–æ –µ–¥–∏–Ω–æ–º—É —à–∞–±–ª–æ–Ω—É –¥–ª—è –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
```json
{bucket}/{user_id}/{session_id}/{timestamp}_{original_filename}
```
–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```json
user-uploads/42/sess_abc123/20260225_143000_contract.pdf
user-uploads/42/sess_abc123/20260225_143000_screenshot.png
analysis-reports/123456789/sess_abc123/20260225_143500_report.pdf
```

### –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ [docker-compose.yaml](configuration/docker-compose.yaml) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –±–∞–∫–µ—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å lifecycle-–ø—Ä–∞–≤–∏–ª–∞. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —É—Ç–∏–ª–∏—Ç—É `mc` (MinIO Client).

**–®–∞–≥ 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ mc (–Ω–∞ —Ö–æ—Å—Ç-–º–∞—à–∏–Ω–µ –∏–ª–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)**

```bash
# –í–∞—Ä–∏–∞–Ω—Ç –ê: —Å–∫–∞—á–∞—Ç—å mc –Ω–∞ —Ö–æ—Å—Ç-–º–∞—à–∏–Ω—É
wget https://dl.min.io/client/mc/release/linux-amd64/mc
chmod +x mc
sudo mv mc /usr/local/bin/

# –í–∞—Ä–∏–∞–Ω—Ç –ë: –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker exec -it redflag-minio bash
```

**–®–∞–≥ 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É**

```bash
# ¬´redflag¬ª ‚Äî –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –∏–º—è alias –¥–ª—è –Ω–∞—à–µ–≥–æ MinIO-—Å–µ—Ä–≤–µ—Ä–∞
mc alias set redflag http://localhost:9000 redflag_admin YOUR_STRONG_MINIO_PASSWORD
```

**–®–∞–≥ 3. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∫–µ—Ç–æ–≤**

```bash
mc mb redflag/user-uploads
mc mb redflag/analysis-reports
```

**–®–∞–≥ 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ lifecycle-–ø—Ä–∞–≤–∏–ª (–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤)**
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª—ã —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞:

```json
// lifecycle-uploads.json ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 –¥–µ–Ω—å
{
  "Rules": [
    {
      "ID": "AutoDeleteUploads",
      "Status": "Enabled",
      "Expiration": {
        "Days": 1
      }
    }
  ]
}
```

```json
// lifecycle-uploads.json ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
{
  "Rules": [
    {
      "ID": "AutoDeleteUploads",
      "Status": "Enabled",
      "Expiration": {
        "Days": 7
      }
    }
  ]
}
```

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª:
```bash
mc ilm import redflag/user-uploads < lifecycle-uploads.json
mc ilm import redflag/analysis-reports < lifecycle-reports.json
```

**–®–∞–≥ 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–∞–∫–µ—Ç–æ–≤
mc ls redflag

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å lifecycle-–ø—Ä–∞–≤–∏–ª–∞
mc ilm ls redflag/user-uploads
mc ilm ls redflag/analysis-reports
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è `n8n`

–î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã `n8n` —Å `MinIO` —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ (–Ω–µ `root`).

1. –ß–µ—Ä–µ–∑ –≤–µ–±-–∫–æ–Ω—Å–æ–ª—å MinIO (http://localhost:9001) –≤–æ–π—Ç–∏ —Å root-–ª–æ–≥–∏–Ω–æ–º (redflag_admin)
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ Identity ‚Üí Users ‚Üí Create User.
3. –£–∫–∞–∑–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
   - Access Key: n8n_service
   - Secret Key: YOUR_N8N_SERVICE_PASSWORD
4. –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É: —Å–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É `n8n-policy`
5. –£–∫–∞–∑–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É –≤ –≤–∏–¥–µ —Ñ–∞–π–ª–∞ JSON:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::user-uploads/*",
        "arn:aws:s3:::user-uploads",
        "arn:aws:s3:::analysis-reports/*",
        "arn:aws:s3:::analysis-reports"
      ]
    }
  ]
}
```
6. –≠—Ç–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç n8n —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∫–µ—Ç–∞–º–∏ `user-uploads` –∏ `analysis-reports`.